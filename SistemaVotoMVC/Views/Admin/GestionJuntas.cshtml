@using SistemaVotoModelos.DTOs
@model IEnumerable<JuntaDetalleDto>
@{
    ViewData["Title"] = "Gestión de Juntas";
    var direcciones = ViewBag.Direcciones as List<SistemaVotoModelos.Direccion>;
    var posiblesJefes = ViewBag.PosiblesJefes as List<SistemaVotoModelos.Votante>;
}

<div class="container mt-4">
    <h2>🏗️ Administración de Mesas y Juntas</h2>
    <hr />

    <div class="mb-3 d-flex gap-2">
        <button class="btn btn-warning fw-bold" data-bs-toggle="modal" data-bs-target="#modalCrear">
            <i class="bi bi-plus-square"></i> Generar Mesas
        </button>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success">@TempData["Mensaje"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="card shadow-sm">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Ubicación (Recinto)</th>
                    <th>Mesa N°</th>
                    <th>Jefe Asignado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.Ubicacion</td>
                        <td class="fw-bold">@item.NumeroMesa</td>
                        <td>
                            @if (item.NombreJefe == "Sin asignar")
                            {
                                <span class="badge bg-danger">Sin Asignar</span>
                            }
                            else
                            {
                                <span class="badge bg-success">@item.NombreJefe</span>
                            }
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="abrirAsignar(@item.Id)">
                                <i class="bi bi-person-check"></i> Asignar Jefe
                            </button>
                            <form asp-action="EliminarJunta" method="post" class="d-inline" onsubmit="return confirm('¿Eliminar mesa?');">
                                <input type="hidden" name="id" value="@item.Id" />
                                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalCrear" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="CrearJuntas" method="post" class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Generar Mesas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Recinto (Dirección)</label>
                <select name="direccionId" class="form-select mb-3" required>
                    @if (direcciones != null)
                    {
                        foreach (var d in direcciones)
                        {
                            <option value="@d.Id">@d.Provincia - @d.Canton - @d.Parroquia</option>
                        }
                    }
                </select>
                <label>Cantidad de Mesas</label>
                <input type="number" name="cantidad" class="form-control" value="1" min="1" required />
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning w-100">Generar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalAsignar" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="AsignarJefe" method="post" class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Asignar Jefe de Junta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="juntaId" id="inputJuntaId" />
                <label>Votante</label>
                <select name="cedulaJefe" class="form-select" required>
                    <option value="">-- Seleccionar Persona --</option>
                    @if (posiblesJefes != null)
                    {
                        foreach (var v in posiblesJefes)
                        {
                            <option value="@v.Cedula">@v.Cedula - @v.NombreCompleto</option>
                        }
                    }
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100">Guardar Asignación</button>
            </div>
        </form>
    </div>
</div>

<script>
    function abrirAsignar(id) {
        document.getElementById('inputJuntaId').value = id;
        new bootstrap.Modal(document.getElementById('modalAsignar')).show();
    }
</script>